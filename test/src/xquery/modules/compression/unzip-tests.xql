xquery version "3.0";

module namespace uz="http://exist-db.org/testsuite/unzips";

import module namespace test="http://exist-db.org/xquery/xqsuite" at "resource:org/exist/xquery/lib/xqsuite/xqsuite.xql";

import module namespace compression="http://exist-db.org/xquery/compression";


declare variable $uz:collection-name := "unzip-test";
declare variable $uz:collection := "/db/" || $uz:collection-name;

declare variable $uz:myFile-name := "myFile.xml";
declare variable $uz:myFile-serialized := "<file/>";


declare variable $uz:myStaticUTF8ContentBase64 := xs:base64Binary("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NCU5MCVFMiU5NCU5NCVFMiU5NCVCNCVFMiU5NCVBQyVFMiU5NCU5QyVFMiU5NCU4MCVFMiU5NCVCQyVFMiU5NSU5RSVFMiU5NSU5RiVFMiU5NSU5QSVFMiU5NSU5NCVFMiU5NSVBOSVFMiU5NSVBNiVFMiU5NSVBMCVFMiU5NSU5MCVFMiU5NSVBQyVFMiU5NSVBNyVFMiU5NSVBOCVFMiU5NSVBNCVFMiU5NSVBNSVFMiU5NSU5OSVFMiU5NSU5OCVFMiU5NSU5MiVFMiU5NSU5MyVFMiU5NSVBQiVFMiU5NSVBQSVFMiU5NCU5OCVFMiU5NCU4QyVFMiU5NiU4OCVFMiU5NiU4NCVFMiU5NiU4QyVFMiU5NiU5MCVFMiU5NiU4MCVDRSVCMSVDMyU5RiVDRSU5MyVDRiU4MCVDRSVBMyVDRiU4MyVDMiVCNSVDRiU4NCVDRSVBNiVDRSU5OCVDRSVBOSVDRSVCNCVFMiU4OCU5RSVDRiU4NiVDRSVCNSVFMiU4OCVBOSVFMiU4OSVBMSVDMiVCMSVFMiU4OSVBNSVFMiU4OSVBNCVFMiU4QyVBMCVFMiU4QyVBMSVDMyVCNyVFMiU4OSU4OCVDMiVCMCVFMiU4OCU5OSVDMiVCNyVFMiU4OCU5QSVFMiU4MSVCRiVDMiVCMiVFMiU5NiVBMC54bWxQSwUGAAAAAAEAAQBvBAAAnwQAAAAA");
declare variable $uz:myStaticCP437ContentBase64 := xs:base64Binary("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NCU5MCVFMiU5NCU5NCVFMiU5NCVCNCVFMiU5NCVBQyVFMiU5NCU5QyVFMiU5NCU4MCVFMiU5NCVCQyVFMiU5NSU5RSVFMiU5NSU5RiVFMiU5NSU5QSVFMiU5NSU5NCVFMiU5NSVBOSVFMiU5NSVBNiVFMiU5NSVBMCVFMiU5NSU5MCVFMiU5NSVBQyVFMiU5NSVBNyVFMiU5NSVBOCVFMiU5NSVBNCVFMiU5NSVBNSVFMiU5NSU5OSVFMiU5NSU5OCVFMiU5NSU5MiVFMiU5NSU5MyVFMiU5NSVBQiVFMiU5NSVBQSVFMiU5NCU5OCVFMiU5NCU4QyVFMiU5NiU4OCVFMiU5NiU4NCVFMiU5NiU4QyVFMiU5NiU5MCVFMiU5NiU4MCVDRSVCMSVDMyU5RiVDRSU5MyVDRiU4MCVDRSVBMyVDRiU4MyVDMiVCNSVDRiU4NCVDRSVBNiVDRSU5OCVDRSVBOSVDRSVCNCVFMiU4OCU5RSVDRiU4NiVDRSVCNSVFMiU4OCVBOSVFMiU4OSVBMSVDMiVCMSVFMiU4OSVBNSVFMiU4OSVBNCVFMiU4QyVBMCVFMiU4QyVBMSVDMyVCNyVFMiU4OSU4OCVDMiVCMCVFMiU4OCU5OSVDMiVCNyVFMiU4OCU5QSVFMiU4MSVCRiVDMiVCMiVFMiU5NiVBMC54bWxQSwUGAAAAAAEAAQBvBAAAnwQAAAAA");

....


declare variable $uz:myZipFileName := "myZipCp437.zip";
declare variable $uz:myZipEntries2 := (<entry name="ööööööö" type="uri">{$uz:collection}/{$uz:myFile-name}</entry>);
declare variable $uz:myZipContentBase642 := compression:zip($uz:myZipEntries2, true(), $uz:collection, "Cp437"); 
declare variable $uz:myZip := xmldb:store($uz:collection, $uz:myZipFileName, $uz:myZipContentBase642);

declare
    %test:setUp
function uz:setup() {
    let $coll := xmldb:create-collection("/db", $uz:collection-name)
    return (
        sm:chmod(xs:anyURI($coll), "rwxrwxrwx"),
        xmldb:store($uz:collection, $uz:myFile-name, util:parse($uz:myFile-serialized)),
        xmldb:store($uz:collection, $uz:myZipFileName, $uz:myZip)
    )
};

declare
    %test:tearDown
function uz:cleanup() {
    xmldb:remove($uz:collection)
};

declare
    %test:user("guest", "guest")
    %test:args("myFile.xml")
    %test:assertTrue
function uz:fnDocAvailable($myFile-name as xs:string) {
    doc-available($uz:collection || "/" || $myFile-name)
};

declare
    %test:user("guest", "guest")
	%test:args("myFile.xml")
	%test:assertEquals("<file/>")
function uz:fnContentAvailable($myFile-name as xs:string) {
    doc($uz:collection || "/" || $myFile-name)
};

